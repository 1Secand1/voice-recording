<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="./static/img/index/fav.svg" type="image/x-icon">
  <title>Voice assistant</title>

  <link rel="stylesheet" href="./static/staile/index.css">
  <link rel="stylesheet" href="./static/staile/normalize.css">

  <script defer src="./static/script/audioScript.js"></script>
  <script defer src="./static/script/script.js"></script>
</head>

<body>


  <div class="wrap">
    <section class="logo">
      <img class="logo__img" src="../static/img/index/logo.svg" alt="">

      <p class="logo__text">
        GPT voice assistant
      </p>
    </section>


    <section id="voiceRecording" class="voice-recording ">
      <button class="voice-button"></button>
    </section>
  </div>

  <!-- <a id="download">Download</a> -->

  <audio id="download" controls src="">

</body>

</html>

<script>

  const audioRecording = document.getElementById("download");
  const button = document.getElementById("voiceRecording");
  let recordingPermission = false;

  const handleSuccess = function (stream) {
    const options = { mimeType: "audio/webm" };
    let recordedChunks = [];
    const mediaRecorder = new MediaRecorder(stream, options);

    mediaRecorder.addEventListener("dataavailable", (e) => {
      if (e.data.size > 0) recordedChunks.push(e.data);
    });

    mediaRecorder.addEventListener("stop", () => {
      audioRecording.src = URL.createObjectURL(new Blob(recordedChunks));
    });

    button.addEventListener("mouseup", () => {
      if (recordingPermission) {
        mediaRecorder.stop();
        console.log("Запись остановлена");
      }
    });

    button.addEventListener("mousedown", () => {
      requestAuthorizationToRequest();
      if (recordingPermission) {
        recordedChunks = [];
        mediaRecorder.start();
        console.log("Запись запущена");
      }
    });
  };

  function requestAuthorizationToRequest() {
    navigator.permissions.query({ name: "microphone" }).then(function (result) {
      if (result.state == "granted") {
        recordingPermission = true;

        navigator.mediaDevices.getUserMedia({ audio: true, video: false })
          .then(handleSuccess)
          .catch(error => console.log(error));

        return;
      } else {
        navigator.mediaDevices.getUserMedia({ audio: true, video: false })
          .then(handleSuccess)
          .catch(error => console.log(error));
      }
      result.onchange = function () { };
    });
  }

</script>